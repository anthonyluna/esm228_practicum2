---
title: "Practicum 2"
author: "AJ Zenkowski, Anthony Luna, Allison Hacker"
date: "5/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load, echo=FALSE}
# Load the required packages
library(DeclareDesign)
library(knitr)
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(kableExtra)
```


### Measurement 2: Strong coalitions between fishermen and suppliers 

**Target Population**: 1000 total fishing vessel captains and fish suppliers in the Monterey, Santa Cruz, and Half-Moon Bay Area. The population contains 700 fishers and 300 fish suppliers. Since suppliers are on land more often than fishers they tend to be more involved in coalition planning and meetings than fishers and therefore are more likely to percieve the coalitions that they are a part of as strong compared to fishers.

```{r pop}
## Declare Population
set.seed(228)
population <- declare_population(
  respondents = add_level(N=1000, 
     fisher=sample(c(rep(0,300),rep(1,700))),
     strong_coalition=correlate(given = fisher, rho = -0.5,
                         draw_binary, prob = 0.5)
))

pop <- population()

kable(table(pop$fisher,pop$strong_coalition)) %>% 
  add_header_above(c("fisher"=1,"strong coalition"=2))
```

```{r declare-report}
# Declare reporting probabilities
reporting <- declare_assignment(blocks=fisher,
                  assignment_variable = "R", 
                  block_prob=c(0.7,0.3)) #Block randomly assign respondents to the reporting category. Respondents who are not fishers (ie suppliers) are more likely to be "reporters" (R==1), meaning that they are more likely to be in port/market when enumerators try to administer the survey.
pop <- reporting(pop)

kable(table(pop$fisher,pop$strong_coalition)) %>% 
  add_header_above(c("fisher"=1,"strong_coalition"=2))
```


**Challenge of drawing a representative sample**: Fishing vessel captains are spend a lot of their time out at sea, so they are less available to respond to a survey than fish suppliers are. Additionally, there are more fishermen than fish suppliers. These factors make it difficult to draw a representative sample from the population.

```{r disp-sample}
# Constructing a disproportionate sample

sims <- 1000 #simulations
store <- rep(NA, sims)
fisher <- rep(NA, sims)
supplier <- rep(NA, sims)

fisher.index <- which(pop$fisher==1) #respondent IDs corresponding to fishers (fisher==1)
supplier.index <- which(pop$fisher==0) #respondent IDs corresponding to suppliers (fisher==0)
  
  sam <- c(sample(fisher.index,275),
           sample(supplier.index,75)) #constructing a sample that contains 75 suppliers and 275 fishers.
```

**Sampling procedure**: Stratified sampling at ports and fish markets with unequal effort according to differences in likelihood of reporting between fishers and suppliers.
```{r disp-strat}
# Disproportionate stratification 
for (i in 1:sims){
  sam <- c(sample(fisher.index,275),
           sample(supplier.index,75)) #drawn sample
  pop <- reporting(pop)
  fisher[i] <- mean(pop[sam,] %>%
               filter(R==1 & fisher==1) %>%
               pull(strong_coalition))
  supplier[i] <- mean(pop[sam,] %>%
               filter(R==1 & fisher==0) %>%
               pull(strong_coalition))
  store[i] <- fisher[i] * 0.7 + supplier[i] * 0.3
}
  
# Disproportionate histograms  
  fisher.hist2 <- ggplot(data.frame(fisher), aes(x=fisher)) + 
  geom_histogram(color="black", fill="white") +
  xlab("Mean value of strata sample") +
  geom_vline(xintercept = mean(pop$strong_coalition[pop$fisher==1]), linetype="dashed", color = "blue", size=1.5) +
  ggtitle("Fishers") + xlim(c(0,1))

supplier.hist2 <- ggplot(data.frame(supplier), aes(x=supplier)) + 
  geom_histogram(color="black", fill="white") +
  xlab("Mean value of strata sample") +
  geom_vline(xintercept = mean(pop$strong_coalition[pop$fisher==0]), linetype="dashed", color = "blue", size=1.5) +
  ggtitle("Suppliers") + xlim(c(0,1))

grid.arrange(fisher.hist2,supplier.hist2,ncol=2)
```

# Measurement 6: Improve traceability in the global seafood supply chain - Anthony

**Target Population**: Products listed in the Seafood Watch "Best Choice" iist. We assume that domestic and farmed products are easier to meet compliance regarding traceability.This is represented by a weighting of domestic and farmed at $0.3$ and $0.7$ respectively. This has an overall correlative impact such that $\rho = 0.5$.

```{r pop_m6}
#Declare your population
## Declare Population

# Product Categories in best choice list. 
best_choice_categories <- c("Arctic Char (farmed)",
"Barramundi (US & Vietnam farmed)",
"Bass: Striped (US hooks and lines, farmed)",
"Catfish (US)",
"Clams, Cockles, Mussels Cod: Pacific (AK)",
"Crab: King, Snow & Tanner (AK)",
"Lingcod (CA, OR & WA)",
"Oysters (farmed & Canada)",
"Prawn (Canada & US)",
"Rockfish (AK, CA, OR & WA)",
"Sablefish/Black Cod (AK)",
"Salmon (New Zealand, WA lift nets)",
"Sanddab (CA, OR & WA)",
"Scallops (farmed)",
"Shrimp (US farmed)",
"Squid (US)",
"Sole (US)",
"Tilapia (Canada, Ecuador, Peru & US)",
"Trout (US farmed)",
"Tuna: Albacore (trolls, pole and lines)",
"Tuna: Skipjack (Pacific trolls, pole and lines)")

# Assume that there are 100 products in each category

best_choice_list <- rep(best_choice_categories,100)

set.seed(226)
population <- declare_population(
    best_choice_product_uid = add_level(N=length(best_choice_list), 
     best_choice_category=sample(best_choice_list),
     farmed = case_when(grepl("*farmed*",best_choice_category)~.7,T~0 ),
     domestic = case_when(grepl("(AK|CA|OR|WA|US)",best_choice_category)~.3,T~0),
     track_ease = farmed+domestic,
     # Assume 7 metadatum
     product_compliant = correlate(given=track_ease, rho = .5,draw_binary,prob=.8)
))

pop <- population()

kable(table(pop$best_choice_category,pop$product_compliant)) %>% 
  add_header_above(c("Category"=1,"Category Compliance"=2))
```
```{r delare-report_m6}
#Declare Reporting Probabilities
reporting <- declare_assignment(prob=0.8) #Block randomly assign respondents to the reporting category. Respondents who are not fishers (ie suppliers) are more likely to be "reporters" (R==1), meaning that they are more likely to be in port/market when enumerators try to administer the survey.
reporting <- reporting(pop)

kable(table(pop$best_choice_category,pop$product_compliant)) %>% 
  add_header_above(c("Category"=1,"Category Compliance"=2))
```


**Challenge of drawing a representative sample**:
```{r disp-sample_m6}
#Constucting Disproportionate Sample
sims <- 1000 #simulations
store <- rep(NA, sims)
fisher <- rep(NA, sims)
supplier <- rep(NA, sims)

fisher.index <- which(pop$fisher==1) #respondent IDs corresponding to fishers (fisher==1)
supplier.index <- which(pop$fisher==0) #respondent IDs corresponding to suppliers (fisher==0)
  
  sam <- c(sample(fisher.index,275),
           sample(supplier.index,75)) #constructing a sample that contains 75 suppliers and 275 fishers.
```


**Sampling procedure**: 
```{r display-strat_m6}
# Disproportionate stratification 
# Disproportionate histograms  
for (i in 1:sims){
  sam <- c(sample(fisher.index,275),
           sample(supplier.index,75)) #drawn sample
  pop <- reporting(pop)
  fisher[i] <- mean(pop[sam,] %>%
               filter(R==1 & fisher==1) %>%
               pull(strong_coalition))
  supplier[i] <- mean(pop[sam,] %>%
               filter(R==1 & fisher==0) %>%
               pull(strong_coalition))
  store[i] <- fisher[i] * 0.7 + supplier[i] * 0.3
}
  
# Disproportionate histograms  
  fisher.hist2 <- ggplot(data.frame(fisher), aes(x=fisher)) + 
  geom_histogram(color="black", fill="white") +
  xlab("Mean value of strata sample") +
  geom_vline(xintercept = mean(pop$strong_coalition[pop$fisher==1]), linetype="dashed", color = "blue", size=1.5) +
  ggtitle("Fishers") + xlim(c(0,1))

supplier.hist2 <- ggplot(data.frame(supplier), aes(x=supplier)) + 
  geom_histogram(color="black", fill="white") +
  xlab("Mean value of strata sample") +
  geom_vline(xintercept = mean(pop$strong_coalition[pop$fisher==0]), linetype="dashed", color = "blue", size=1.5) +
  ggtitle("Suppliers") + xlim(c(0,1))

grid.arrange(fisher.hist2,supplier.hist2,ncol=2)
```



# Measurement 1: Increase awareness for sustainable seafood 

**Target Population**

Our target population that the sample will try to represent is the population of adults in Monterey County California (World Population Review 2019). The survey will seek to establish their awareness of sustainable seafood by asking if they're familiar with the Seafood Watch Program. The survey will take place outside three frequently visited grocery stores: Whole Foods, Safeway, and WalMart. The chosen baselines were based on the idea that those who shop at more expensive grocery stores are more likely to have heard of Seafood watch, with half the population of Whole Foods Shoppers expected to be familiar with the program. The number of shoppers available for surveying is based off of the daily foot traffic of each store. 


```{r pop_m1}
set.seed(228)
population <- declare_population(
  store = add_level(N=3,
                    baseline = c(0.5, 0.3, 0.2)), #guessing that half of Whole Foods shoppers are familiar with seafood watch, 30 percent of Safeway shoppers, and 20 percent of WalMart shoppers.
     shoppers = add_level(N=c(404,1279,1899),
     familiar=draw_binary(baseline)))

pop <- population()
pop.vector <- c(404,1279,1899)

my_estimand <- declare_estimands(mean(familiar),
                                 label = "Ybar")

reporting <- declare_assignment(prob=0.4, #assume forty percent of people asked will be willing to take the survey
                  assignment_variable = "R")


```


**Challenge of drawing a representative sample**:

Shoppers at certain grocery stores may not be representative of the entire population of Monterey County. Things that can influence likelihood of familiarity with the Seafood Watch Program include economic status and seafood consumption practices. Both of these have an effect on where a person shops. To counteract this effect, three stores with diverse clientele across customers were chosen. Because income is correllated with sustainable food preferences, the stores with more expensive products are more likely to have customers familiar with the program and were weighted as such. 
```{r disp-sample_m1}

sampling <- declare_sampling(strata=store, #because there are less possible respondents at whole foods, we will take 75 responses there and 100 at both Safeway and Wal Mart.
               strata_n=c(75,100,100))
```


**Sampling procedure**: 

Sampling using the weighted stratifications.

```{r display-strat_m1}
strata_weighted_mean <- function(data){
  data.frame(  
  estimator_label = "strata_w_mean",
  estimand_label = "Ybar",
  n = nrow(data),
  stringsAsFactors = FALSE,
  
  estimate = data %>% filter(R==1) %>% 
    group_by(store) %>% 
    summarise(mean=mean(familiar)) %>%
    mutate(prop=pop.vector/sum(pop.vector)) %>% 
    mutate(sub.mean=mean*prop) %>% pull(sub.mean) %>% 
    sum())
}  
```

